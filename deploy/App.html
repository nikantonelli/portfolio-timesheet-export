<!DOCTYPE html>
<html>
<head>
    <title>portfolio-timesheet-export</title>

    <script type="text/javascript" src="/apps/2.0/sdk-debug.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",stateful:!0,id:"app",cache:[],items:[{id:"panel",xtype:"panel",layout:"column",items:[{name:"intervalType",xtype:"combo",store:Ext.create("Ext.data.ArrayStore",{fields:["interval"],data:[["Today"],["This Week"],["Last Week"],["This Month"],["Last Month"]]}),valueField:"interval",displayField:"interval",queryMode:"local",forceSelection:!0,boxLabelAlign:"after",fieldLabel:"Interval",margin:"5 5 5 5",listeners:{scope:this,select:function(list,item){var startDateCmp=Ext.getCmp("startDate"),endDateCmp=Ext.getCmp("endDate"),start,end,dt=new Date;switch(_.first(item).get("interval")){case"Today":start=Ext.Date.clearTime(dt),end=Ext.Date.clearTime(Ext.Date.add(start,Ext.Date.MILLI,864e5-1));break;case"This Week":start=Ext.Date.clearTime(Ext.Date.subtract(dt,Ext.Date.DAY,dt.getDay())),end=Ext.Date.clearTime(Ext.Date.add(start,Ext.Date.MILLI,6048e5-1));break;case"Last Week":start=Ext.Date.clearTime(Ext.Date.subtract(dt,Ext.Date.DAY,7+dt.getDay())),end=Ext.Date.clearTime(Ext.Date.add(start,Ext.Date.MILLI,6048e5-1));break;case"This Month":start=new Date("1/"+dt.getMonth()+1+"/"+dt.getFullYear()),end=Ext.Date.subtract(Ext.Date.add(start,Ext.Date.MONTH,1),Ext.Date.MILLI,1);break;case"Last Month":start=new Date("1/"+dt.getMonth()+1+"/"+dt.getFullYear()),start=Ext.Date.subtract(start,Ext.Date.MONTH,1),end=Ext.Date.subtract(Ext.Date.add(start,Ext.Date.MONTH,1),Ext.Date.MILLI,1)}startDateCmp.setValue(start),startDateCmp.getValue(),endDateCmp.setValue(end),endDateCmp.getValue(),app.createTimeValueStore()}}},{id:"startDate",margin:"5 5 5 5",xtype:"datefield",format:"d M Y",stateful:!0,stateId:"tsDate1",fieldLabel:"Start Date",value:new Date},{id:"endDate",margin:"5 5 5 5",xtype:"datefield",stateful:!0,stateId:"tsDate2",format:"d M Y",fieldLabel:"End Date",value:new Date,listeners:{select:function(field,value){console.log("value:",value),app.createTimeValueStore()}}},{id:"exportButton",margin:"5 5 5 5",xtype:"rallybutton",text:"Export",handler:function(){var saveDialog=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,draggable:!0,width:300,title:"Export all records",items:[{xtype:"rallybutton",text:"CSV",handler:function(){app.exporter.exportCSV(app.grid),saveDialog.destroy()}},{xtype:"rallybutton",text:"SAP XML",handler:function(){app.exporter.exportSAPXML(app.grid),saveDialog.destroy()}},{xtype:"rallybutton",text:"Cancel",handler:function(){Ext.destroy(saveDialog)},flex:1}]})}}]}],launch:function(){app=this,this._onLoad()},_onLoad:function(){app._loadAStoreWithAPromise("TypeDefinition",!0,[{property:"Ordinal",operator:"!=",value:-1}]).then({success:function(records){app.piTypes=records,console.log("pitypes:",records),app.exporter=Ext.create("GridExporter"),app.createTimeValueStore()}})},createTimeValueStore:function(){app.showMask("Loading Time Sheet Values"),_.isNull(app.grid)||app.remove(app.grid);var nr=null;(nr=Ext.getCmp("noRecords"))&&nr.destroy();var filter=app._getDateFilter();console.log(filter),Ext.create("Rally.data.wsapi.Store",{model:"TimeEntryValue",fetch:!0,filters:filter,limit:"Infinity"}).load({callback:function(records,operation,successful){0===records.length&&(app.hideMask(),app.add({html:"No records for this date range",itemId:"norecords",id:"noRecords"})),app.readRelatedValues(records,function(){app.hideMask();var message=app.down("#norecords");_.isUndefined(message)||app.remove(message),console.log("records",records),app.createArrayStoreFromRecords(records)})}})},getFieldValue:function(record,field){var hasValue=function(value){return!_.isUndefined(value)&&!_.isNull(value)&&""!==value};return hasValue(record.get("TaskObject"))&&hasValue(record.get("TaskObject").get(field))?record.get("TaskObject").get(field):hasValue(record.get("StoryObject"))&&hasValue(record.get("StoryObject").get(field))?record.get("StoryObject").get(field):hasValue(record.get("FeatureObject"))&&hasValue(record.get("FeatureObject").get(field))?record.get("FeatureObject").get(field):hasValue(record.get("EpicObject"))&&hasValue(record.get("EpicObject").get(field))?record.get("EpicObject").get(field):null},createArrayStoreFromRecords:function(records){var fields=[{displayName:"User",name:"UserName"},{displayName:"Task",name:"TaskDisplayString"},{displayName:"Project",name:"ProjectDisplayString"},{displayName:"Work Product",name:"WorkProductDisplayString"},{displayName:"Feature ID",name:"FeatureID"},{displayName:"Feature Title",name:"FeatureName"},{displayName:"Epic ID",name:"EpicID"},{displayName:"Epic Title",name:"EpicName"},{displayName:"Hours Entered",name:"Hours"},{displayName:"Unique ID",name:"ObjectID"},{displayName:"Date",name:"Date"}],data=_.map(records,function(r){return{UserName:r.get("UserObject").get("UserName"),TaskDisplayString:r.get("TimeEntryItemObject").get("TaskDisplayString"),ProjectDisplayString:r.get("TimeEntryItemObject").get("ProjectDisplayString"),WorkProductDisplayString:r.get("TimeEntryItemObject").get("WorkProductDisplayString"),FeatureID:r.get("FeatureObject")?r.get("FeatureObject").get("FormattedID"):null,FeatureName:r.get("FeatureObject")?r.get("FeatureObject").get("Name"):null,EpicID:r.get("EpicObject")?r.get("EpicObject").get("FormattedID"):null,EpicName:r.get("EpicObject")?r.get("EpicObject").get("Name"):null,Hours:r.get("Hours"),ObjectID:r.get("ObjectID"),Date:Ext.Date.format(r.get("DateVal"),"D d M Y")}}),store=Ext.create("Ext.data.JsonStore",{fields:fields,data:data});app.grid=new Ext.grid.GridPanel({header:!1,id:"tsGrid",title:"TimeSheetData",features:[{ftype:"grouping",showSummaryRow:!0,groupHeaderTpl:" {name} ({children.length} items)"}],store:store,columns:_.map(fields,function(f){return"Hours"!==f.name?{text:f.displayName,dataIndex:f.name}:{text:f.displayName,dataIndex:f.name,summaryType:"sum",summaryRenderer:function(value,summaryData,dataIndex){return Ext.String.format('<div style="background-color:#E4EECF">Total: {0}</div>',value)}}})}),this.add(app.grid)},readRelatedValues:function(values,callback){app.readTimeEntryItems(values).then({success:function(items){console.log("items",items),app.setValues(values,items,"TimeEntryItemObject"),app.readUsers(items).then({success:function(users){console.log("users",users),app.setValues(values,users,"UserObject"),app.readTasks(items).then({success:function(tasks){console.log("tasks",tasks),app.setValues(values,tasks,"TaskObject"),app.readStories(items).then({success:function(stories){console.log("stories",stories),app.setValues(values,stories,"StoryObject"),app.readFeatures(stories).then({success:function(features){console.log("features",features),app.setValues(values,features,"FeatureObject"),app.readEpics(features).then({success:function(epics){console.log("epics",epics),app.setValues(values,epics,"EpicObject"),callback()}})}})}})}})}})}})},setValues:function(items,values,attrName){_.each(items,function(item,x){item.set(attrName,values[x])})},readObject:function(model,ref){var deferred=Ext.create("Deft.Deferred"),obj=_.find(app.cache,function(cacheObj){return cacheObj.ref._ref===ref._ref?cacheObj.promise.promise:void 0});return _.isUndefined(obj)||_.isNull(obj)?(Rally.data.ModelFactory.getModel({type:model,success:function(model){model.load(ref,{fetch:!0,callback:function(result,operation){deferred.resolve(result)}})}}),app.cache.push({ref:ref,promise:deferred}),deferred.promise):obj.promise.promise},readStories:function(items){var promises=_.map(items,function(item){var deferred=Ext.create("Deft.Deferred"),workProductRef=item.get("WorkProduct");return null===workProductRef||"HierarchicalRequirement"!==workProductRef._type?deferred.resolve(null):app.readObject("HierarchicalRequirement",workProductRef).then({success:function(obj){deferred.resolve(obj)}}),deferred.promise});return Deft.Promise.all(promises)},readTasks:function(items){var promises=_.map(items,function(item){var deferred=Ext.create("Deft.Deferred"),taskRef=item.get("Task");return _.isUndefined(taskRef)||_.isNull(taskRef)?deferred.resolve(null):app.readObject("Task",taskRef).then({success:function(obj){deferred.resolve(obj)}}),deferred.promise});return Deft.Promise.all(promises)},readUsers:function(items){var promises=_.map(items,function(item){var deferred=Ext.create("Deft.Deferred"),userRef=item.get("User");return _.isUndefined(userRef)||_.isNull(userRef)?deferred.resolve(null):app.readObject("User",userRef).then({success:function(obj){deferred.resolve(obj)}}),deferred.promise});return Deft.Promise.all(promises)},readTimeEntryItems:function(values){var promises=_.map(values,function(v){var deferred=Ext.create("Deft.Deferred"),ref=v.get("TimeEntryItem");return app.readObject("TimeEntryItem",ref).then({success:function(obj){deferred.resolve(obj)}}),deferred.promise});return Deft.Promise.all(promises)},readFeatures:function(stories){var promises=_.map(stories,function(story){var deferred=Ext.create("Deft.Deferred");if(_.isNull(story)||_.isUndefined(story.get("Feature"))||_.isNull(story.get("Feature")))deferred.resolve(null);else{var featureRef=story.get("Feature"),featureType=_.first(app.piTypes).get("TypePath");app.readObject(featureType,featureRef).then({success:function(obj){deferred.resolve(obj)}})}return deferred.promise});return Deft.Promise.all(promises)},readEpics:function(features){var promises=_.map(features,function(feature){var deferred=Ext.create("Deft.Deferred");if(_.isNull(feature)||_.isUndefined(feature.get("Parent"))||_.isNull(feature.get("Parent")))deferred.resolve(null);else{var epicRef=feature.get("Parent"),epicType=app.piTypes[1].get("TypePath");app.readObject(epicType,epicRef).then({success:function(obj){deferred.resolve(obj)}})}return deferred.promise});return Deft.Promise.all(promises)},_getDateFilter:function(){var startDateCmp=Ext.getCmp("startDate").getValue(),endDateCmp=Ext.getCmp("endDate").getValue(),start=Rally.util.DateTime.toIsoString(startDateCmp,!1),end=Rally.util.DateTime.toIsoString(endDateCmp,!1);return[{property:"DateVal",operator:">=",value:start},{property:"DateVal",operator:"<=",value:end}]},_onSelect:function(){var grid=Ext.getCmp("tsGrid"),store=grid.getStore();store.clearFilter(!0),store.filter(app._getDateFilter())},_onSelectDate:function(a,b,c){console.log(a,b,c)},showMask:function(msg){this.getEl()&&(this.getEl().unmask(),this.getEl().mask(msg))},hideMask:function(){this.getEl().unmask()},_loadAStoreWithAPromise:function(model_name,model_fields,filters,ctx,order){var deferred=Ext.create("Deft.Deferred"),me=this,config={model:model_name,fetch:model_fields,filters:filters,limit:"Infinity"};return _.isUndefined(ctx)||_.isNull(ctx)||(config.context=ctx),_.isUndefined(order)||_.isNull(order)||(config.order=order),Ext.create("Rally.data.wsapi.Store",config).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise}});
                Ext.define("GridExporter",{dateFormat:"Y-m-d",inheritableStatics:{XmlFileHeader:'<?xml version="1.0"?>',XmlFileExtension:".xml.txt"},_downloadFiles:function(files){if(files.length){var data=files.pop(),format=files.pop(),file=files.pop(),href="<a href='"+format+","+encodeURIComponent(data)+"' download='"+file+"'></a>",ml=Ext.DomHelper.insertAfter(window.document.getElementById("tsGrid"),href);ml.click(),this._downloadFiles(files)}},exportCSV:function(grid){var data=this._getCSV(grid);data=data.replace(/\'/g,""),this._downloadFiles(["export.csv","data:text/csv;charset=utf8",data])},_XMLIndent:function(index,tag,leaf,data){for(var text="\n",i=0;index>i;i++)text+="	";if(text+="<"+tag+">",text+=data,!leaf)for(text+="\n",i=0;index>i;i++)text+="	";return text+="</"+tag+">"},_addSAPTrailerFile:function(data){var file="E1BPCATS8",format="data:text/text;charset=utf8",text=this.self.XmlFileHeader;return text+="\n<"+file+">",_.each(data,function(record){text+=this._XMLIndent(1,"Datarow",!1,this._XMLIndent(2,"GUID",!0,record.get("ObjectID"))+this._XMLIndent(2,"ROW",!0,"")+this._XMLIndent(2,"FORMAT_COL",!0,"*")+this._XMLIndent(2,"TEXT_LINE",!0,""))},this),text+="</"+file+">\n",file+=this.self.XmlFileExtension,[file,format,text]},_addSAPHeaderFile:function(data){var file="E1CATS_INSERT",format="data:text/text;charset=utf8",text=this.self.XmlFileHeader;return text+="\n<"+file+">",_.each(data,function(record){text+=this._XMLIndent(1,"Datarow",!1,this._XMLIndent(2,"GUID",!0,record.get("ObjectID"))+this._XMLIndent(2,"PROFILE",!0,record.get("c_KMDEmployeeID")||"")+this._XMLIndent(2,"TEXT_FORMAT_IMP",!0,"ITF"))},this),text+="</"+file+">\n",file+=this.self.XmlFileExtension,[file,format,text]},_addSAPDataFile:function(data){var file="E1BPCATS1",format="data:text/text;charset=utf8",text=this.self.XmlFileHeader;return text+="\n<"+file+">",_.each(data,function(record){text+=this._XMLIndent(1,"Datarow",!1,this._XMLIndent(2,"GUID",!0,record.get("ObjectID")||"")+this._XMLIndent(2,"WORKDATE",!0,Ext.Date.format(new Date(record.get("Date")),"Ymd"))+this._XMLIndent(2,"EMPLOYEENUMBER",!0,record.get("c_KMDEmployeeID")||"")+this._XMLIndent(2,"ACTTYPE",!0,"")+this._XMLIndent(2,"NETWORK",!0,record.get("c_SAPNetwork")||"")+this._XMLIndent(2,"ACTIVITY",!0,record.get("c_SAPOperation")||"")+this._XMLIndent(2,"SUB_ACTIVITY",!0,record.get("c_SAPSubOperation")||"")+this._XMLIndent(2,"CATSHOURS",!0,record.get("Hours"))+this._XMLIndent(2,"UNIT",!0,"H")+this._XMLIndent(2,"SHORTTEXT",!0,record.get("TaskDisplayString")||record.get("WorkProductDisplayString")||"")+this._XMLIndent(2,"LONGTEXT",!0,""))},this),text+="</"+file+">\n",file+=this.self.XmlFileExtension,[file,format,text]},exportSAPXML:function(grid){var filesToSave=[];if(grid&&grid.store&&grid.store.data){var data=grid.store.data.items;this._downloadFiles(filesToSave.concat(this._addSAPHeaderFile(data),this._addSAPDataFile(data),this._addSAPTrailerFile(data)))}},_escapeForCSV:function(string){return string=""+string,string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string},_getFieldText:function(fieldData,record,col,index){var text;return text=null===fieldData||void 0===fieldData?"":fieldData._refObjectName&&!fieldData.getMonth?fieldData._refObjectName:fieldData instanceof Date?Ext.Date.format(fieldData,this.dateFormat):fieldData},_getFieldTextAndEscape:function(fieldData,record,col,index){var string=this._getFieldText(fieldData,record,col,index);return this._escapeForCSV(string)},fixedColumnCount:function(columns){var cols=_.filter(columns,function(c){return void 0!==c&&null!==c&&c.locked===!0});return cols.length},_getCSV:function(grid){var cols=grid.columns,store=grid.store,data="",that=this;return Ext.Array.each(cols,function(col,index){if(col.hidden!==!0){var colLabel=col.dataIndex;colLabel=colLabel.replace(/<br\/?>/,""),data+=that._getFieldTextAndEscape(colLabel)+","}}),data+="\n",_.each(store.data.items,function(record,i){Ext.Array.each(cols,function(col,index){if(col.hidden!==!0){var fieldName=col.dataIndex,text=record.get(fieldName);data+=that._getFieldTextAndEscape(text,record,col,index)+","}}),data+="\n"}),data}});

            Rally.launchApp('CustomApp', {
                name:"portfolio-timesheet-export",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
